name: library-update
run-name: ${{ github.workflow }} (${{ github.ref_name }})

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: update-${{ github.ref }}
  cancel-in-progress: true

jobs:

  cache:
    runs-on: ${{ vars.RUNNER_IMAGE }}
    outputs:
      source-files-updated: ${{ steps.compare.outputs.source-files }}
      docs-updated: ${{ steps.compare.outputs.docs }}

    steps:
    - name: Git Checkout
      uses: actions/checkout@v3
      with:
        path: main

    - name: Compute hash
      run: |
        set -eu

        find ./main/ -type f -name '*.cpp' -or -name '*.hpp' | sort > ./file-list.txt
        cat ./file-list.txt | xargs sha1sum > ./cache-list.txt
        sha1sum ./cache-list.txt | sed 's/\s\s*.*$//g' > ./source-files-cache.txt

        echo "::group::Source files [cache: $(cat ./source-files-cache.txt)]"
        cat ./cache-list.txt;
        echo '::endgroup'
        
        cat ./source-files-cache.txt > ./cache-list.txt
        find ./main/.verify-helper/docs/ -type f | sort > ./file-list.txt
        cat ./file-list.txt | xargs sha1sum >> ./cache-list.txt
        sha1sum ./cache-list.txt | sed 's/\s\s*.*$//g' > ./docs-cache.txt

        echo "::group::Docs [cache: $(cat ./docs-cache.txt)]"
        cat ./cache-list.txt;
        echo '::endgroup'

    - name: Load previous source files hash
      uses: dawidd6/action-download-artifact@v3
      with:
        name: source-files-hash
        path: ./prev-source-files-hash.sh
        workflow_conclusion: success
        search_artifacts: true
        if_no_artifact_found: ignore

    - name: Compare cached hash
      id: compare
      run: |
        set -eu

        diff -q ./source-files-cache.txt ./prev-source-files-cache.txt
        echo "source-files=$?" >> ${GITHUB_OUTPUT}

        diff -q ./docs-cache.txt ./prev-docs-cache.txt
        echo 'docs=$?' >> ${GITHUB_OUTPUT}

    - name: Upload sorce files hash
      uses: actions/upload-artifact@v3
      with:
        name: source-code-hash
        path: ./source-files-cache.txt

    - name: Upload sorce code hash
      uses: actions/upload-artifact@v3
      with:
        name: docs-hash
        path: ./docs-cache.txt

  analyze:
    needs: cache
    if: ${{ needs.job1.outputs.output1 == '1' }}
    uses: ./.github/workflows/analyze.yml

  verify:
    needs: cache
    if: >
      ${{ !cancelled() &&
        needs.job1.outputs.output1 == '1' &&
        github.ref_name == github.event.repository.default_branch
      }}
    uses: ./.github/workflows/verify.yml
    secrets: inherit

  documantaion:
    needs:
      - cache
      - analyze
      - verify
    if: >
      ${{ !cancelled() &&
        needs.job1.outputs.output1 == '1' &&
        github.ref_name == github.event.repository.default_branch
      }}
    uses: ./.github/workflows/gen-docs.yml
    secrets: inherit
