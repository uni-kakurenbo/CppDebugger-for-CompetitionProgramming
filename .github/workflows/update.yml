name: library-update
run-name: ${{ github.workflow }} (${{ github.ref_name }})

on:
  workflow_dispatch:
    inputs:
      force:
        type: boolean
        default: false
        required: true
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: update-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cache:
    if: ${{ !inputs.force }}
    uses: ./.github/workflows/load-prev-runs.yml

  quit:
    needs: cache
    if: needs.cache.outputs.verify-status == 'failure'
    runs-on: ${{ vars.RUNNER_IMAGE }}
    steps:
    - run: exit 1

  config:
    runs-on: ${{ vars.RUNNER_IMAGE }}
    outputs:
      run-analyze: >-
        ${{
          needs.cache.outputs.verify-status == '' ||
          inputs.force
        }}
      run-verify: >-
        ${{
          (
            needs.cache.outputs.verify-status == '' ||
            needs.cache.outputs.verify-status == 'cancelled' ||
            inputs.force
          ) &&
          github.ref_name == github.event.repository.default_branch
        }}
      gen-docs: >-
        ${{
          (
            needs.cache.outputs.docs-updated == '0' ||
            inputs.force
          ) &&
          github.ref_name == github.event.repository.default_branch
        }}

  analyze:
    needs: config
    if: ${{ !cancelled() && needs.config.outputs.run-analyze }}
    uses: ./.github/workflows/analyze.yml

  verify:
    needs: config
    if: ${{ !cancelled() && needs.config.outputs.run-verify }}
    uses: ./.github/workflows/verify.yml
    secrets: inherit

  documantaion:
    needs:
      - config
      - analyze
      - verify
    if: ${{ !cancelled() && needs.config.outputs.gen-docs }}
    uses: ./.github/workflows/gen-docs.yml
    secrets: inherit

  post-cache:
    needs:
      - cache
      - config
      - verify
    uses: ./.github/workflows/save-verify-status.yml
    if: ${{ !cancelled() && needs.cache.result && needs.config.outputs.run-verifyx }}
    with:
      status: ${{ needs.verify.result }}
