name: library-update
run-name: ${{ github.workflow }} (${{ github.ref_name }})

on:
  workflow_dispatch:
    inputs:
      force:
        type: boolean
        default: false
        required: true
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: update-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cache:
    uses: ./.github/workflows/load-prev-runs.yml

  config:
    needs: cache
    if: ${{ !cancelled() }}
    runs-on: ${{ vars.RUNNER_IMAGE }}

    outputs:
      quit: ${{ env.QUIT }}
      run-analysis: ${{ env.ANALYSIS }}
      run-verify: ${{ env.VERIFY }}
      gen-docs: ${{ env.DOCS }}

    env:
      QUIT: ${{ !inputs.force && needs.cache.outputs.verify-status == 'failure' }}

      ANALYSIS: ${{ inputs.force || needs.cache.outputs.verify-status == '' }}

      VERIFY: >-
        ${{
          github.ref_name == github.event.repository.default_branch &&
          (
            inputs.force ||
            needs.cache.outputs.verify-status == '' ||
            needs.cache.outputs.verify-status == 'cancelled'
          )
        }}

      DOCS: >-
        ${{
          github.ref_name == github.event.repository.default_branch &&
          (inputs.force || needs.cache.outputs.docs-updated == true)
        }}

    steps:
      - name: Set variables
        id: set-vars
        run: |
          echo "Quit: ${QUIT}"
          echo "Analysis: ${ANALYSIS}"
          echo "Verify: ${VERIFY}"
          echo "Docs: ${DOCS}"

  quit:
    needs: config
    if: ${{ !cancelled() && needs.config.outputs.quit == 'true' }}
    runs-on: ${{ vars.RUNNER_IMAGE }}
    steps:
    - run: exit 1

  analyze:
    needs: config
    if: ${{ !cancelled() && needs.config.outputs.run-analysis == 'true' }}
    uses: ./.github/workflows/analyze.yml

  verify:
    needs: config
    if: ${{ !cancelled() && needs.config.outputs.run-verify == 'true' }}
    uses: ./.github/workflows/verify.yml
    secrets: inherit

  documantaion:
    needs:
      - config
      - analyze
      - verify
    if: ${{ !cancelled() && needs.config.outputs.gen-docs == 'true' }}
    uses: ./.github/workflows/gen-docs.yml
    secrets: inherit

  post-cache-verify:
    name: post-cache
    needs:
      - cache
      - verify
    uses: ./.github/workflows/save-status.yml
    if: ${{ !cancelled() && needs.cache.result == 'success' && needs.verify.result != 'skipped' }}
    with:
      key: source-files-hash
      status: ${{ needs.verify.result }}

  post-cache-docs:
    name: post-cache
    needs:
      - cache
      - documantaion
    uses: ./.github/workflows/save-status.yml
    if: ${{ !cancelled() && needs.cache.result == 'success' && needs.documantaion.result != 'skipped' }}
    with:
      key: docs-files-hash
      status: ${{ needs.verify.result }}
